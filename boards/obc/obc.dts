/*
 * Copyright (c) 2025 The FINCH CubeSat Project Flight Software Contributors
 *
 * SPDX-License-Identifier: Apache-2.0
 */

/dts-v1/;

#include <st/g4/stm32g431Xb.dtsi>
#include <dt-bindings/pinctrl/stm32-pinctrl.h>

/ {
	model = "finch,obc";
	compatible = "finch,obc";

	chosen {
		zephyr,sram = &sram0;
		zephyr,flash = &flash0;
		zephyr,code-partition = &slot0_partition;
		zephyr,console = &usart1;
	};

	leds: leds {
		compatible = "gpio-leds";
		act_led: led_0 {
			gpios = <&gpioc 2 GPIO_ACTIVE_HIGH>;
			label = "LED0";
		};
		wrn_led: led_1 {
			gpios = <&gpioc 3 GPIO_ACTIVE_HIGH>;
			label = "LED1";
		};
	};

	aliases {
		led0 = &act_led;
		actled = &act_led;
		led1 = &wrn_led;
		wrnled = &wrn_led;
	};
};

&clk_hse {
	clock-frequency = <DT_FREQ_M(24)>;
	status = "okay";
};

&pll {
	div-m = <6>;
	mul-n = <85>;
	div-p = <7>;
	div-q = <2>;
	div-r = <2>;
	clocks = <&clk_hse>;
	status = "okay";
};

&rcc {
	clocks = <&pll>;
	clock-frequency = <DT_FREQ_M(170)>;
	ahb-prescaler = <1>;
	apb1-prescaler = <1>;
	apb2-prescaler = <1>;
	status = "okay";
};

&flash0 {
	partitions {
		compatible = "fixed-partitions";
		#address-cells = <1>;
		#size-cells = <1>;
		slot0_partition: partition@0 {
			label = "image-0";
			reg = <0x00000000 DT_SIZE_K(64)>;
		};
	};
};

&usart1 {
	pinctrl-0 = <&usart1_tx_pb7 &usart1_rx_pb6>;
	pinctrl-names = "default";
	status = "okay";
};

&pinctrl {
	usart1_rx_pb6: usart1_rx_pb6 {
		pinmux = <STM32_PINMUX('B', 6, AF7)>;
	};

	usart1_tx_pb7: usart1_tx_pb7 {
		pinmux = <STM32_PINMUX('B', 7, AF7)>;
	};
};

&quadspi {
    status = "okay";
    pinctrl-0 = <&ospi1_clk_pb2 &ospi1_ncs_pb6 &ospi1_io0_pe12 &ospi1_io1_pe13 &ospi1_io2_pe14 &ospi1_io3_pe15>;
    pinctrl-names = "default";

    flash0: flash@0 {
        compatible = "jedec,spi-nor";
        reg = <0>;
        spi-max-frequency = <108000000>;   // Adjust to your flash max freq (e.g. 108 MHz for H7)
        size = <67108864>;                 // 64 Mbit = 8 MB (for W25Q64, adjust for your flash)
        jedec-id = [ c2 20 18 ];           // Optional: Macronix MX25R6435F example
                                           // Zephyr will auto-detect via SFDP if not set
        has-dpd;                           // If flash supports Deep Power Down
        t-enter-dpd = <10000>;             // 10us
        t-exit-dpd = <30000>;              // 30us
    };
};
